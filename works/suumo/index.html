<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">

  <title>あ！スーモ！</title>

  <script>
  (function() {
      // from:http://curtaincall.weblike.jp/portfolio-web-sounder/webaudioapi-basic/demos/demo-08
      var onDOMContentLoaded = function() {
   
          window.AudioContext = window.AudioContext || window.webkitAudioContext;
   
          try {
              // Create the instance of AudioContext
              var context = new AudioContext();
          } catch (error) {
              window.alert(error.message + ' : Please use Chrome or Safari.');
              return;
          }
   
          // for legacy browsers
          context.createGain = context.createGain || context.createGainNode;
   
          // Create the instance of GainNode
          var gain = context.createGain();
   
          var suumo = [
            "あ❗️スーモ❗️🌚",
            "ダン💥", "ダン💥", "ダン💥", "シャーン🎶",
            "スモ🌝", "スモ🌚", "スモ🌝", "スモ🌚",
            "スモ🌝", "スモ🌚", "ス〜〜〜モ⤴🌝",
            "スモ🌚", "スモ🌝", "スモ🌚", "スモ🌝",
            "スモ🌚", "スモ🌝", "ス〜〜〜モ⤵🌞"
          ];
          var song = new Array(suumo.length);
          var text = "";

          //https://bost.ocks.org/mike/shuffle/
          var m = suumo.length, t, i;
          for (i = 0; i < m; i++) {
            song[i] = i;
          }
          // While there remain elements to shuffle…
          while (m) {
            // Pick a remaining element…
            i = Math.floor(Math.random() * m--);

            // And swap it with the current element.
            t = song[m];
            song[m] = song[i];
            song[i] = t;
          }
          for (i = 0; i < m; i++) {
            text += suumo[n];
          }

          document.getElementById("box").innerHTML = "" + text;   
          // for the instances of AudioBuffer
          var buffers = new Array(suumo.length);
   
          // for the instances of AudioBufferSourceNode
          var sources = new Array(suumo.length);
   
          var interval;  // sec
   
          // Create original event
          var event = document.createEvent('Event');
          event.initEvent('complete', true, true);
   
          // Get ArrayBuffer by Ajax
          var load = function(url, index) {
              var xhr = new XMLHttpRequest();
   
              // Timeout (1 minutes)
              xhr.timeout = 60000;
   
              xhr.ontimeout = function() {
                  window.alert('Timeout.');
              };
   
              xhr.onerror = function() {
                  window.alert('Ajax Error.');
              };
   
              xhr.onload = function() {
                  if (xhr.status === 200) {
                      var arrayBuffer = xhr.response;  // Get ArrayBuffer
   
                      if (arrayBuffer instanceof ArrayBuffer) {
                          // The 2nd argument for decodeAudioData
                          var successCallback = function(audioBuffer) {
                              // Get the instance of AudioBuffer
                              buffers[index] = audioBuffer;
   
                              // The loading instances of AudioBuffer has completed ?
                              for (var i = 0, len = buffers.length; i < len; i++) {
                                  if (buffers[i] === undefined) {
                                      return;
                                  }
                              }
   
                              // dispatch 'complete' event
                              document.querySelector('button').dispatchEvent(event);
                          };
   
                          // The 3rd argument for decodeAudioData
                          var errorCallback = function(error) {
                              if (error instanceof Error) {
                                  window.alert(error.message);
                              } else {
                                  window.alert('Error : "decodeAudioData" method.');
                              }
                          };
   
                          // Create the instance of AudioBuffer (Asynchronously)
                          context.decodeAudioData(arrayBuffer, successCallback, errorCallback);
                      }
                  }
              };
   
              xhr.open('GET', url, true);
              xhr.responseType = 'arraybuffer';
              xhr.send(null);
          };
   
          for (var i = 0, len = suumo.length; i < len; i++) {
              load('./audio/suumo_' + i + ".mp3", i);
          }
   
          document.querySelector('button').addEventListener('complete', function() {
             
              this.addEventListener('click', function() {
                  // Get base time
                  var t0 = context.currentTime;
   
                  for (var i = 0, len = buffers.length; i < len; i++) {
                      // Create the instance of AudioBufferSourceNode
                      sources[song[i]] = context.createBufferSource();
   
                      // for legacy browsers
                      sources[song[i]].start = sources[song[i]].start || sources[song[i]].noteGrainOn;  // noteGrainOn
                      sources[song[i]].stop  = sources[song[i]].stop  || sources[song[i]].noteOff;
   
                      // Set the instance of AudioBuffer
                      sources[song[i]].buffer = buffers[song[i]];
   
                      // AudioBufferSourceNode (Input) -> GainNode (Master Volume) -> AudioDestinationNode (Output)
                      sources[song[i]].connect(gain);
                      gain.connect(context.destination);

                      interval = sources[song[i]].buffer.duration - 0.05;
                      sources[song[i]].start(t0, 0, interval);
                      sources[song[i]].stop(t0 + interval);
                      t0 += interval;
                  }
              }, false);
   
          }, false);
      };
   
      if ((document.readyState === 'interactive') || (document.readyState === 'complete')) {
          onDOMContentLoaded();
      } else {
          document.addEventListener('DOMContentLoaded', onDOMContentLoaded, true);
      }
   
  })();
  </script>
</head>

<body>
<button type="button">a</button>
<div id="box"></div>
</body>

</html>
